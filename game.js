const translations = {
    ru: {
        orientation_warning: "Пожалуйста, поверните устройство горизонтально",
        shoot: "ОГОНЬ",
        reload: "ПЕРЕЗАРЯДКА",
        ammo: "Патроны",
        score: "Очки",
        health: "Здоровье",
        title: "ZOMBIE SHOOTER 3D",
        balance: "Баланс",
        start: "НАЧАТЬ ИГРУ",
        missions: "ЗАДАНИЯ",
        shop: "МАГАЗИН",
        language: "СМЕНИТЬ ЯЗЫК",
        missions_title: "ЗАДАНИЯ",
        social_missions: "СОЦИАЛЬНЫЕ ЗАДАНИЯ",
        mission1: "Убить 10 зомби",
        mission2: "Набрать 1000 очков",
        mission3: "Выжить 5 минут",
        mission4: "Убить 25 зомби",
        mission5: "Набрать 5000 очков",
        mission6: "Выжить 10 минут",
        mission7: "Сделать 50 выстрелов",
        mission8: "Перезарядить 20 раз",
        mission9: "Убить 5 зомби без урона",
        mission10: "Собрать 100 патронов",
        mission11: "Убить зомби с 1 выстрела",
        mission12: "Выжить с 10% здоровья",
        mission13: "Убить 3 зомби за 10 секунд",
        mission19: "Убить 50 зомби за игру",
        mission20: "Достичь комбо из 10 убийств",
        mission21: "Выжить без перезарядки 2 минуты",
        mission22: "Убить 15 зомби с полным здоровьем",
        mission23: "Набрать 10000 очков за игру",
        mission14: "Подписаться на Telegram",
        mission15: "Подписаться на Telegram",
        mission16: "Подписаться на X",
        mission17: "Подписаться на YouTube",
        mission18: "Поделиться игрой",
        reward: "Награда",
        points: "очков",
        claim: "Получить награду",
        confirm_sub: "Подтвердить подписку",
        share: "Поделиться",
        shop_title: "МАГАЗИН",
        health_upgrade: "Увеличение здоровья",
        health_desc: "+20 к максимальному здоровью",
        damage_upgrade: "Увеличение урона",
        damage_desc: "+25% к урону",
        firerate_upgrade: "Скорострельность",
        firerate_desc: "-50мс к задержке выстрела",
        ammo_upgrade: "Дополнительные патроны",
        ammo_desc: "+10 к максимуму патронов",
        speed_upgrade: "Скорость передвижения",
        speed_desc: "+20% к скорости",
        armor_upgrade: "Броня",
        armor_desc: "-10% получаемого урона",
        price: "Цена",
        buy: "Купить",
        back: "НАЗАД",
        game_over: "ИГРА ОКОНЧЕНА",
        final_score: "Ваш счет",
        completed_missions: "Выполненные задания",
        restart: "ИГРАТЬ СНОВА",
        menu: "В ГЛАВНОЕ МЕНЮ",
        share_text: "Zombie Shooter 3D - Попробуй крутой шутер с зомби! Я уже набрал {score} очков!",
        copied: "Ссылка скопирована в буфер обмена!",
        copy_failed: "Не удалось скопировать ссылку",
        confirm_telegram: "Вы подписались на канал {channel}?",
        congrats: "Поздравляем! Вы получили {reward} очков!"
    },
    en: {
        orientation_warning: "Please rotate your device to landscape",
        shoot: "FIRE",
        reload: "RELOAD",
        ammo: "Ammo",
        score: "Score",
        health: "Health",
        title: "ZOMBIE SHOOTER 3D",
        balance: "Balance",
        start: "START GAME",
        missions: "MISSIONS",
        shop: "SHOP",
        language: "CHANGE LANGUAGE",
        missions_title: "MISSIONS",
        social_missions: "SOCIAL MISSIONS",
        mission1: "Kill 10 zombies",
        mission2: "Score 1000 points",
        mission3: "Survive 5 minutes",
        mission4: "Kill 25 zombies",
        mission5: "Score 5000 points",
        mission6: "Survive 10 minutes",
        mission7: "Make 50 shots",
        mission8: "Reload 20 times",
        mission9: "Kill 5 zombies without damage",
        mission10: "Collect 100 ammo",
        mission11: "Kill a zombie with 1 shot",
        mission12: "Survive with 10% health",
        mission13: "Kill 3 zombies in 10 seconds",
        mission19: "Kill 50 zombies in one game",
        mission20: "Achieve a 10-kill combo",
        mission21: "Survive without reloading for 2 minutes",
        mission22: "Kill 15 zombies with full health",
        mission23: "Score 10000 points in one game",
        mission14: "Follow Telegram",
        mission15: "Follow Telegram",
        mission16: "Follow on X",
        mission17: "Subscribe to YouTube",
        mission18: "Share the game",
        reward: "Reward",
        points: "points",
        claim: "Claim Reward",
        confirm_sub: "Confirm Subscription",
        share: "Share",
        shop_title: "SHOP",
        health_upgrade: "Health Upgrade",
        health_desc: "+20 to max health",
        damage_upgrade: "Damage Upgrade",
        damage_desc: "+25% to damage",
        firerate_upgrade: "Fire Rate",
        firerate_desc: "-50ms to shot delay",
        ammo_upgrade: "Extra Ammo",
        ammo_desc: "+10 to max ammo",
        speed_upgrade: "Movement Speed",
        speed_desc: "+20% to speed",
        armor_upgrade: "Armor",
        armor_desc: "-10% damage taken",
        price: "Price",
        buy: "Buy",
        back: "BACK",
        game_over: "GAME OVER",
        final_score: "Your score",
        completed_missions: "Completed missions",
        restart: "PLAY AGAIN",
        menu: "MAIN MENU",
        share_text: "Zombie Shooter 3D - Try this awesome zombie shooter! I've scored {score} points!",
        copied: "Link copied to clipboard!",
        copy_failed: "Failed to copy link",
        confirm_telegram: "Have you subscribed to {channel}?",
        congrats: "Congratulations! You received {reward} points!"
    },
    ja: {
        orientation_warning: "デバイスを横にしてください",
        shoot: "発射",
        reload: "リロード",
        ammo: "弾薬",
        score: "スコア",
        health: "ヘルス",
        title: "ゾンビシューター3D",
        balance: "残高",
        start: "ゲーム開始",
        missions: "ミッション",
        shop: "ショップ",
        language: "言語変更",
        missions_title: "ミッション",
        social_missions: "ソーシャルミッション",
        mission1: "ゾンビ10体を倒す",
        mission2: "1000ポイント獲得",
        mission3: "5分間生き残る",
        mission4: "ゾンビ25体を倒す",
        mission5: "5000ポイント獲得",
        mission6: "10分間生き残る",
        mission7: "50回射撃する",
        mission8: "20回リロードする",
        mission9: "ダメージを受けずにゾンビ5体を倒す",
        mission10: "弾薬100個収集",
        mission11: "1発でゾンビを倒す",
        mission12: "10%のヘルスで生き残る",
        mission13: "10秒以内にゾンビ3体を倒す",
        mission19: "1ゲームでゾンビ50体を倒す",
        mission20: "10連続キルを達成",
        mission21: "2分間リロードせずに生き残る",
        mission22: "フルヘルスでゾンビ15体を倒す",
        mission23: "1ゲームで10000ポイント獲得",
        mission14: "Telegramをフォロー",
        mission15: "Telegramをフォロー",
        mission16: "Xでフォロー",
        mission17: "YouTubeを購読",
        mission18: "ゲームを共有",
        reward: "報酬",
        points: "ポイント",
        claim: "報酬を受け取る",
        confirm_sub: "購読を確認",
        share: "共有",
        shop_title: "ショップ",
        health_upgrade: "ヘルス強化",
        health_desc: "最大ヘルス+20",
        damage_upgrade: "ダメージ強化",
        damage_desc: "ダメージ+25%",
        firerate_upgrade: "連射速度",
        firerate_desc: "ショットの遅延-50ms",
        ammo_upgrade: "追加弾薬",
        ammo_desc: "最大弾薬+10",
        speed_upgrade: "移動速度",
        speed_desc: "速度+20%",
        armor_upgrade: "アーマー",
        armor_desc: "受けるダメージ-10%",
        price: "価格",
        buy: "購入",
        back: "戻る",
        game_over: "ゲームオーバー",
        final_score: "あなたのスコア",
        completed_missions: "完了したミッション",
        restart: "もう一度プレイ",
        menu: "メインメニュー",
        share_text: "ゾンビシューター3D - この素晴らしいゾンビシューターを試してみて！私は{score}ポイントを獲得しました！",
        copied: "リンクがクリップボードにコピーされました！",
        copy_failed: "リンクのコピーに失敗しました",
        confirm_telegram: "{channel}を購読しましたか？",
        congrats: "おめでとう！{reward}ポイントを獲得しました！"
    }
};

let currentLanguage = 'ru';

const GameData = {
    totalScore: 0,
    maxHealth: 100,
    damageMultiplier: 1,
    shotDelay: 250,
    maxAmmo: 30,
    moveSpeed: 0.05,
    damageReduction: 1,
    shotsFired: 0,
    reloads: 0,
    zombiesNoDamage: 0,
    collectedAmmo: 0,
    oneShotKills: 0,
    lowHealthSurvival: false,
    sessionZombies: 0,
    killCombo: 0,
    lastReloadTime: 0,
    noReloadTime: 0,
    fullHealthKills: 0,
    sessionScore: 0,
    missions: {
        1: { killed: 0, completed: false },
        2: { score: 0, completed: false },
        3: { time: 0, completed: false },
        4: { killed: 0, completed: false },
        5: { score: 0, completed: false },
        6: { time: 0, completed: false },
        7: { shots: 0, completed: false },
        8: { reloads: 0, completed: false },
        9: { noDamageKills: 0, completed: false },
        10: { ammo: 0, completed: false },
        11: { oneShot: 0, completed: false },
        12: { lowHealth: false, completed: false },
        13: { quickKills: 0, completed: false },
        14: { completed: false },
        15: { completed: false },
        16: { completed: false },
        17: { completed: false },
        18: { completed: false },
        19: { sessionKilled: 0, completed: false },
        20: { combo: 0, completed: false },
        21: { noReloadTime: 0, completed: false },
        22: { fullHealthKills: 0, completed: false },
        23: { sessionScore: 0, completed: false }
    },
    
    save() {
        localStorage.setItem('zombieShooterData', JSON.stringify({
            totalScore: this.totalScore,
            maxHealth: this.maxHealth,
            damageMultiplier: this.damageMultiplier,
            shotDelay: this.shotDelay,
            maxAmmo: this.maxAmmo,
            moveSpeed: this.moveSpeed,
            damageReduction: this.damageReduction,
            shotsFired: this.shotsFired,
            reloads: this.reloads,
            zombiesNoDamage: this.zombiesNoDamage,
            collectedAmmo: this.collectedAmmo,
            oneShotKills: this.oneShotKills,
            lowHealthSurvival: this.lowHealthSurvival,
            sessionZombies: this.sessionZombies,
            killCombo: this.killCombo,
            lastReloadTime: this.lastReloadTime,
            noReloadTime: this.noReloadTime,
            fullHealthKills: this.fullHealthKills,
            sessionScore: this.sessionScore,
            missions: this.missions
        }));
    },
    
    load() {
        const data = localStorage.getItem('zombieShooterData');
        if (data) {
            const parsed = JSON.parse(data);
            this.totalScore = parsed.totalScore;
            this.maxHealth = parsed.maxHealth;
            this.damageMultiplier = parsed.damageMultiplier;
            this.shotDelay = parsed.shotDelay || 250;
            this.maxAmmo = parsed.maxAmmo || 30;
            this.moveSpeed = parsed.moveSpeed || 0.05;
            this.damageReduction = parsed.damageReduction || 1;
            this.shotsFired = parsed.shotsFired || 0;
            this.reloads = parsed.reloads || 0;
            this.zombiesNoDamage = parsed.zombiesNoDamage || 0;
            this.collectedAmmo = parsed.collectedAmmo || 0;
            this.oneShotKills = parsed.oneShotKills || 0;
            this.lowHealthSurvival = parsed.lowHealthSurvival || false;
            this.sessionZombies = parsed.sessionZombies || 0;
            this.killCombo = parsed.killCombo || 0;
            this.lastReloadTime = parsed.lastReloadTime || 0;
            this.noReloadTime = parsed.noReloadTime || 0;
            this.fullHealthKills = parsed.fullHealthKills || 0;
            this.sessionScore = parsed.sessionScore || 0;
            this.missions = parsed.missions;
        }
        this.updateUI();
    },
    
    updateUI() {
        document.getElementById('total-score').textContent = `${translations[currentLanguage].balance}: ${this.totalScore} ${translations[currentLanguage].points}`;
    }
};

class ZombieShooter {
    constructor() {
        this.scene = new THREE.Scene();
        this.camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        this.renderer = new THREE.WebGLRenderer({
            canvas: document.getElementById('game'),
            antialias: true
        });
        
        this.renderer.setSize(window.innerWidth, window.innerHeight);
        this.renderer.setClearColor(0x000000);
        
        this.shootSound = new Audio('pistolet_zvuk.mp3');
        
        const textureLoader = new THREE.TextureLoader();
        this.groundTexture = textureLoader.load('texture.png', 
            (texture) => {
                texture.wrapS = THREE.RepeatWrapping;
                texture.wrapT = THREE.RepeatWrapping;
                texture.repeat.set(4, 4);
                if (this.floor) {
                    this.floor.material.map = texture;
                    this.floor.material.needsUpdate = true;
                }
            },
            (progress) => {
                console.log('Загрузка текстуры: ' + (progress.loaded / progress.total * 100) + '%');
            },
            (error) => {
                console.error('Ошибка загрузки текстуры:', error);
            }
        );
        
        this.score = 0;
        this.health = GameData.maxHealth;
        this.ammo = GameData.maxAmmo;
        this.isGameOver = false;
        this.zombies = [];
        this.bullets = [];
        this.gameTime = 0;
        this.zombiesKilled = 0;
        this.initialHealth = this.health;
        this.quickKillTimer = 0;
        this.quickKills = 0;
        this.sessionZombies = 0;
        this.killCombo = 0;
        this.lastReloadTime = 0;
        this.noReloadTime = 0;
        this.fullHealthKills = 0;
        this.sessionScore = 0;
        this.comboTimer = 0;
        
        this.moveForward = false;
        this.moveBackward = false;
        this.moveLeft = false;
        this.moveRight = false;
        this.lookLeft = false;
        this.lookRight = false;
        this.canShoot = true;
        
        this.setupScene();
        this.setupLights();
        this.setupPlayer();
        this.setupControls();
        
        this.lastTime = performance.now();
        this.animate();
        this.spawnZombies();
    }
    
    setupScene() {
        const skyGeometry = new THREE.SphereGeometry(50, 32, 32);
        const skyMaterial = new THREE.MeshBasicMaterial({
            color: 0x87CEEB,
            side: THREE.BackSide
        });
        const sky = new THREE.Mesh(skyGeometry, skyMaterial);
        this.scene.add(sky);

        const floorGeometry = new THREE.PlaneGeometry(100, 100);
        const floorMaterial = new THREE.MeshStandardMaterial({
            map: this.groundTexture,
            roughness: 0.8,
            color: 0x666666
        });
        this.floor = new THREE.Mesh(floorGeometry, floorMaterial);
        this.floor.rotation.x = -Math.PI / 2;
        this.scene.add(this.floor);
        
        const terrainGeometry = new THREE.PlaneGeometry(20, 20);
        const terrainMaterial = new THREE.MeshStandardMaterial({
            color: 0x1a472a,
            roughness: 0.9
        });
        
        const base1 = new THREE.Mesh(terrainGeometry, terrainMaterial);
        base1.position.set(-15, 0.1, -15);
        base1.rotation.x = -Math.PI / 2;
        this.scene.add(base1);
        
        const base2 = new THREE.Mesh(terrainGeometry, terrainMaterial);
        base2.position.set(15, 0.1, 15);
        base2.rotation.x = -Math.PI / 2;
        this.scene.add(base2);

        for (let i = 0; i < 20; i++) {
            const tree = new THREE.Group();
            const trunkGeometry = new THREE.CylinderGeometry(0.1, 0.15, 2, 8);
            const trunkMaterial = new THREE.MeshStandardMaterial({ color: 0x4a2f10 });
            const trunk = new THREE.Mesh(trunkGeometry, trunkMaterial);
            trunk.position.y = 1;
            tree.add(trunk);
            
            const crownLayers = 3;
            for (let j = 0; j < crownLayers; j++) {
                const crownGeometry = new THREE.ConeGeometry(0.8 - j * 0.2, 1.5, 8);
                const crownMaterial = new THREE.MeshStandardMaterial({ color: 0x2d5a27 });
                const crown = new THREE.Mesh(crownGeometry, crownMaterial);
                crown.position.y = 2 + j * 0.8;
                tree.add(crown);
            }
            
            const angle = Math.random() * Math.PI * 2;
            const distance = 5 + Math.random() * 15;
            tree.position.x = Math.cos(angle) * distance;
            tree.position.z = Math.sin(angle) * distance;
            tree.rotation.y = Math.random() * Math.PI;
            this.scene.add(tree);
            this.trees = this.trees || [];
            this.trees.push(tree);
        }

        for (let i = 0; i < 15; i++) {
            const rockGeometry = new THREE.DodecahedronGeometry(0.5);
            const rockMaterial = new THREE.MeshStandardMaterial({ color: 0x808080 });
            const rock = new THREE.Mesh(rockGeometry, rockMaterial);
            const angle = Math.random() * Math.PI * 2;
            const distance = 5 + Math.random() * 15;
            rock.position.x = Math.cos(angle) * distance;
            rock.position.z = Math.sin(angle) * distance;
            rock.position.y = 0.25;
            this.scene.add(rock);
            this.rocks = this.rocks || [];
            this.rocks.push(rock);
        }
    }
    
    setupLights() {
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.7);
        this.scene.add(ambientLight);
        
        const directionalLight = new THREE.DirectionalLight(0xffffff, 1.5);
        directionalLight.position.set(5, 10, 5);
        this.scene.add(directionalLight);
        
        const secondaryLight = new THREE.DirectionalLight(0xffffff, 0.5);
        secondaryLight.position.set(-5, 8, -5);
        this.scene.add(secondaryLight);
    }
    
    setupPlayer() {
        this.camera.position.y = 1.6;
        this.camera.position.z = 5;
        
        const gunGeometry = new THREE.BoxGeometry(0.1, 0.1, 0.3);
        const gunMaterial = new THREE.MeshStandardMaterial({ color: 0x333333 });
        this.gun = new THREE.Mesh(gunGeometry, gunMaterial);
        this.gun.position.set(0.3, -0.2, -0.5);
        this.camera.add(this.gun);
        this.scene.add(this.camera);
    }
    
    setupControls() {
        const joystick = document.getElementById('joystick');
        const joystickHead = document.getElementById('joystick-head');
        const lookJoystick = document.getElementById('look-joystick');
        const lookJoystickHead = document.getElementById('look-joystick-head');
        let isDraggingMove = false;
        let isDraggingLook = false;
        let startXMove, startYMove, startXLook;
        
        const touchHandler = (e) => {
            e.preventDefault();
            const touch = e.touches[0];
            if (e.target === joystick || e.target === joystickHead) {
                isDraggingMove = true;
                startXMove = touch.clientX;
                startYMove = touch.clientY;
            } else if (e.target === lookJoystick || e.target === lookJoystickHead) {
                isDraggingLook = true;
                startXLook = touch.clientX;
            }
        };

        joystick.addEventListener('touchstart', touchHandler);
        lookJoystick.addEventListener('touchstart', touchHandler);
        
        document.addEventListener('touchmove', (e) => {
            e.preventDefault();
            const touch = e.touches[0];
            if (isDraggingMove) {
                const deltaX = touch.clientX - startXMove;
                const deltaY = touch.clientY - startYMove;
                const maxDistance = 35;
                const distance = Math.min(Math.sqrt(deltaX * deltaX + deltaY * deltaY), maxDistance);
                const angle = Math.atan2(deltaY, deltaX);
                const moveX = Math.cos(angle) * distance;
                const moveY = Math.sin(angle) * distance;
                joystickHead.style.transform = `translate(${moveX}px, ${moveY}px)`;
                this.moveForward = moveY < -10;
                this.moveBackward = moveY > 10;
                this.moveLeft = moveX < -10;
                this.moveRight = moveX > 10;
            }
            if (isDraggingLook) {
                const deltaX = touch.clientX - startXLook;
                const maxDistance = 35;
                const distance = Math.min(Math.abs(deltaX), maxDistance);
                const direction = deltaX > 0 ? 1 : -1;
                const moveX = direction * distance;
                lookJoystickHead.style.transform = `translate(${moveX}px, 0)`;
                this.lookLeft = deltaX < -10;
                this.lookRight = deltaX > 10;
            }
        });
        
        document.addEventListener('touchend', (e) => {
            if (isDraggingMove && !e.touches.length) {
                isDraggingMove = false;
                joystickHead.style.transform = '';
                this.moveForward = this.moveBackward = this.moveLeft = this.moveRight = false;
            }
            if (isDraggingLook && !e.touches.length) {
                isDraggingLook = false;
                lookJoystickHead.style.transform = '';
                this.lookLeft = this.lookRight = false;
            }
        });
        
        const shootBtn = document.getElementById('shoot-btn');
        shootBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            this.shoot();
        });
        
        const reloadBtn = document.getElementById('reload-btn');
        reloadBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            this.reload();
        });
    }
    
    shoot() {
        if (!this.canShoot || this.ammo <= 0) return;
        
        this.shootSound.currentTime = 0;
        this.shootSound.play();
        
        this.ammo--;
        GameData.shotsFired++;
        document.getElementById('ammo-count').textContent = `${translations[currentLanguage].ammo}: ${this.ammo}`;
        
        const bulletGeometry = new THREE.SphereGeometry(0.05);
        const bulletMaterial = new THREE.MeshBasicMaterial({ color: 0xffff00 });
        const bullet = new THREE.Mesh(bulletGeometry, bulletMaterial);
        
        bullet.position.copy(this.camera.position);
        bullet.rotation.copy(this.camera.rotation);
        
        const direction = new THREE.Vector3();
        this.camera.getWorldDirection(direction);
        bullet.velocity = direction.multiplyScalar(0.7);
        
        this.bullets.push(bullet);
        this.scene.add(bullet);
        
        this.canShoot = false;
        setTimeout(() => this.canShoot = true, GameData.shotDelay);
        
        if (!GameData.missions[7].completed) {
            GameData.missions[7].shots = GameData.shotsFired;
            if (GameData.shotsFired >= 50) {
                this.completeMission(7);
            }
        }
    }
    
    reload() {
        if (this.ammo === GameData.maxAmmo) return;
        
        this.lastReloadTime = this.gameTime;
        setTimeout(() => {
            const oldAmmo = this.ammo;
            this.ammo = GameData.maxAmmo;
            GameData.collectedAmmo += (GameData.maxAmmo - oldAmmo);
            GameData.reloads++;
            document.getElementById('ammo-count').textContent = `${translations[currentLanguage].ammo}: ${this.ammo}`;
            if (!GameData.missions[8].completed) {
                GameData.missions[8].reloads = GameData.reloads;
                if (GameData.reloads >= 20) {
                    this.completeMission(8);
                }
            }
            if (!GameData.missions[10].completed) {
                GameData.missions[10].ammo = GameData.collectedAmmo;
                if (GameData.collectedAmmo >= 100) {
                    this.completeMission(10);
                }
            }
        }, 1500);
    }
    
    spawnZombie() {
        const zombieGeometry = new THREE.BoxGeometry(0.6, 1.8, 0.3);
        const zombieMaterial = new THREE.MeshStandardMaterial({ color: 0x00ff00 });
        const zombie = new THREE.Mesh(zombieGeometry, zombieMaterial);
        
        const angle = Math.random() * Math.PI * 2;
        const distance = 15 + Math.random() * 10;
        zombie.position.x = Math.cos(angle) * distance;
        zombie.position.z = Math.sin(angle) * distance;
        zombie.position.y = 0.9;
        
        zombie.health = 100;
        this.zombies.push(zombie);
        this.scene.add(zombie);
    }
    
    spawnZombies() {
        setInterval(() => {
            if (this.zombies.length < 10 && !this.isGameOver) {
                this.spawnZombie();
            }
        }, 3000);
    }
    
    updateZombies() {
        for (let i = this.zombies.length - 1; i >= 0; i--) {
            const zombie = this.zombies[i];
            const direction = new THREE.Vector3();
            direction.subVectors(this.camera.position, zombie.position).normalize();
            zombie.position.add(direction.multiplyScalar(0.03));
            zombie.lookAt(this.camera.position);
            
            if (zombie.position.distanceTo(this.camera.position) < 1.5) {
                this.health -= 0.1 * GameData.damageReduction;
                document.getElementById('health-count').textContent = `${translations[currentLanguage].health}: ${Math.ceil(this.health)}`;
                if (this.health <= 0) {
                    this.gameOver();
                }
            }
        }
    }
    
    updateBullets() {
        for (let i = this.bullets.length - 1; i >= 0; i--) {
            const bullet = this.bullets[i];
            bullet.position.add(bullet.velocity);
            
            for (let j = this.zombies.length - 1; j >= 0; j--) {
                const zombie = this.zombies[j];
                if (bullet.position.distanceTo(zombie.position) < 1) {
                    this.scene.remove(bullet);
                    this.bullets.splice(i, 1);
                    
                    const damage = 50 * GameData.damageMultiplier;
                    zombie.health -= damage;
                    if (zombie.health <= 0) {
                        this.scene.remove(zombie);
                        this.zombies.splice(j, 1);
                        this.score += 100;
                        this.sessionScore += 100;
                        this.zombiesKilled++;
                        this.sessionZombies++;
                        this.killCombo++;
                        this.comboTimer = this.gameTime;
                        if (this.initialHealth === this.health) {
                            GameData.zombiesNoDamage++;
                        }
                        if (this.health === GameData.maxHealth) {
                            this.fullHealthKills++;
                        }
                        if (damage >= 100) {
                            GameData.oneShotKills++;
                        }
                        if (this.quickKillTimer === 0) {
                            this.quickKillTimer = this.gameTime;
                        }
                        this.quickKills++;
                        document.getElementById('score-count').textContent = `${translations[currentLanguage].score}: ${this.score}`;
                        
                        if (!GameData.missions[1].completed) {
                            GameData.missions[1].killed = this.zombiesKilled;
                            if (this.zombiesKilled >= 10) {
                                this.completeMission(1);
                            }
                        }
                        if (!GameData.missions[2].completed && this.score >= 1000) {
                            GameData.missions[2].score = this.score;
                            this.completeMission(2);
                        }
                        if (!GameData.missions[4].completed) {
                            GameData.missions[4].killed = this.zombiesKilled;
                            if (this.zombiesKilled >= 25) {
                                this.completeMission(4);
                            }
                        }
                        if (!GameData.missions[5].completed && this.score >= 5000) {
                            GameData.missions[5].score = this.score;
                            this.completeMission(5);
                        }
                        if (!GameData.missions[9].completed) {
                            GameData.missions[9].noDamageKills = GameData.zombiesNoDamage;
                            if (GameData.zombiesNoDamage >= 5) {
                                this.completeMission(9);
                            }
                        }
                        if (!GameData.missions[11].completed && GameData.oneShotKills >= 1) {
                            GameData.missions[11].oneShot = GameData.oneShotKills;
                            this.completeMission(11);
                        }
                        if (!GameData.missions[13].completed && this.quickKills >= 3 && this.gameTime - this.quickKillTimer <= 10) {
                            GameData.missions[13].quickKills = this.quickKills;
                            this.completeMission(13);
                        }
                        if (!GameData.missions[19].completed) {
                            GameData.missions[19].sessionKilled = this.sessionZombies;
                            if (this.sessionZombies >= 50) {
                                this.completeMission(19);
                            }
                        }
                        if (!GameData.missions[20].completed && this.killCombo >= 10) {
                            GameData.missions[20].combo = this.killCombo;
                            this.completeMission(20);
                        }
                        if (!GameData.missions[22].completed) {
                            GameData.missions[22].fullHealthKills = this.fullHealthKills;
                            if (this.fullHealthKills >= 15) {
                                this.completeMission(22);
                            }
                        }
                        if (!GameData.missions[23].completed && this.sessionScore >= 10000) {
                            GameData.missions[23].sessionScore = this.sessionScore;
                            this.completeMission(23);
                        }
                    }
                    break;
                }
            }
            
            if (bullet.position.length() > 50) {
                this.scene.remove(bullet);
                this.bullets.splice(i, 1);
            }
        }
    }
    
    updateMovement() {
        const speed = GameData.moveSpeed;
        const rotationSpeed = 0.03;
        
        const oldPosition = this.camera.position.clone();
        
        if (this.moveForward) {
            this.camera.position.z -= speed * Math.cos(this.camera.rotation.y);
            this.camera.position.x -= speed * Math.sin(this.camera.rotation.y);
        }
        if (this.moveBackward) {
            this.camera.position.z += speed * Math.cos(this.camera.rotation.y);
            this.camera.position.x += speed * Math.sin(this.camera.rotation.y);
        }
        if (this.moveLeft) {
            this.camera.position.x -= speed * Math.cos(this.camera.rotation.y);
            this.camera.position.z += speed * Math.sin(this.camera.rotation.y);
        }
        if (this.moveRight) {
            this.camera.position.x += speed * Math.cos(this.camera.rotation.y);
            this.camera.position.z -= speed * Math.sin(this.camera.rotation.y);
        }
        if (this.lookLeft) this.camera.rotation.y += rotationSpeed;
        if (this.lookRight) this.camera.rotation.y -= rotationSpeed;
        
        if (this.trees) {
            for (const tree of this.trees) {
                const distance = this.camera.position.distanceTo(tree.position);
                if (distance < 1.5) {
                    this.camera.position.copy(oldPosition);
                }
            }
        }
        
        if (this.rocks) {
            for (const rock of this.rocks) {
                const distance = this.camera.position.distanceTo(rock.position);
                if (distance < 1) {
                    this.camera.position.copy(oldPosition);
                }
            }
        }
    }
    
    completeMission(missionId) {
        const rewards = {
            1: 500,
            2: 1000,
            3: 2000,
            4: 1500,
            5: 3000,
            6: 4000,
            7: 1000,
            8: 800,
            9: 2000,
            10: 1500,
            11: 1000,
            12: 2500,
            13: 2000,
            19: 5000,
            20: 3000,
            21: 2500,
            22: 3500,
            23: 6000
        };
        
        GameData.missions[missionId].completed = true;
        GameData.totalScore += rewards[missionId];
        GameData.save();
        
        const missionElement = document.querySelector(`.mission[data-id="${missionId}"]`);
        if (missionElement) {
            const claimBtn = missionElement.querySelector('.claim-btn');
            claimBtn.disabled = false;
            claimBtn.textContent = translations[currentLanguage].claim;
        }
    }
    
    animate() {
        if (this.isGameOver) return;
        
        requestAnimationFrame(() => this.animate());
        
        const currentTime = performance.now();
        const deltaTime = (currentTime - this.lastTime) / 1000;
        this.lastTime = currentTime;
        
        this.gameTime += deltaTime;
        
        if (!GameData.missions[3].completed) {
            GameData.missions[3].time = this.gameTime;
            if (this.gameTime >= 300) {
                this.completeMission(3);
            }
            const minutes = Math.floor(this.gameTime / 60);
            const seconds = Math.floor(this.gameTime % 60);
            const timeString = `${minutes}:${seconds.toString().padStart(2, '0')}/5:00`;
            document.querySelector('.mission[data-id="3"] .progress').textContent = timeString;
        }
        
        if (!GameData.missions[6].completed) {
            GameData.missions[6].time = this.gameTime;
            if (this.gameTime >= 600) {
                this.completeMission(6);
            }
            const minutes = Math.floor(this.gameTime / 60);
            const seconds = Math.floor(this.gameTime % 60);
            const timeString = `${minutes}:${seconds.toString().padStart(2, '0')}/10:00`;
            document.querySelector('.mission[data-id="6"] .progress').textContent = timeString;
        }
        
        if (!GameData.missions[12].completed && this.health <= GameData.maxHealth * 0.1 && this.health > 0) {
            GameData.missions[12].lowHealth = true;
            this.completeMission(12);
        }
        
        if (!GameData.missions[21].completed && this.gameTime - this.lastReloadTime >= 120) {
            GameData.missions[21].noReloadTime = this.gameTime - this.lastReloadTime;
            this.completeMission(21);
        }
        
        if (this.quickKillTimer > 0 && this.gameTime - this.quickKillTimer > 10) {
            this.quickKills = 0;
            this.quickKillTimer = 0;
        }
        
        if (this.comboTimer > 0 && this.gameTime - this.comboTimer > 5) {
            this.killCombo = 0;
            this.comboTimer = 0;
        }
        
        this.updateMovement();
        this.updateZombies();
        this.updateBullets();
        
        this.renderer.render(this.scene, this.camera);
    }
    
    gameOver() {
        this.isGameOver = true;
        GameData.totalScore += this.score;
        GameData.save();
        
        document.getElementById('game-over').classList.add('active');
        document.getElementById('final-score').textContent = this.score;
        document.getElementById('completed-missions').textContent = 
            Object.values(GameData.missions).filter(m => m.completed).length;
    }
}

function updateLanguage() {
    document.getElementById('orientation-warning').textContent = translations[currentLanguage].orientation_warning;
    document.getElementById('shoot-btn').textContent = translations[currentLanguage].shoot;
    document.getElementById('reload-btn').textContent = translations[currentLanguage].reload;
    document.getElementById('ammo-count').textContent = `${translations[currentLanguage].ammo}: ${GameData.ammo || 30}`;
    document.getElementById('score-count').textContent = `${translations[currentLanguage].score}: ${GameData.score || 0}`;
    document.getElementById('health-count').textContent = `${translations[currentLanguage].health}: ${GameData.maxHealth || 100}`;
    document.getElementById('menu').querySelector('h1').textContent = translations[currentLanguage].title;
    document.getElementById('total-score').textContent = `${translations[currentLanguage].balance}: ${GameData.totalScore} ${translations[currentLanguage].points}`;
    document.getElementById('start-btn').textContent = translations[currentLanguage].start;
    document.getElementById('missions-btn').textContent = translations[currentLanguage].missions;
    document.getElementById('shop-btn').textContent = translations[currentLanguage].shop;
    document.getElementById('language-btn').textContent = translations[currentLanguage].language;
    document.getElementById('missions').querySelectorAll('h2')[0].textContent = translations[currentLanguage].missions_title;
    document.getElementById('missions').querySelectorAll('h2')[1].textContent = translations[currentLanguage].social_missions;
    document.querySelectorAll('.mission').forEach((mission, index) => {
        const id = mission.dataset.id;
        mission.querySelector('h3').textContent = translations[currentLanguage][`mission${id}`];
        if (id <= 23 && id != 14 && id != 15 && id != 16 && id != 17 && id != 18) {
            mission.querySelector('p').textContent = `${translations[currentLanguage].reward}: ${[500,1000,2000,1500,3000,4000,1000,800,2000,1500,1000,2500,2000,0,0,0,0,0,5000,3000,2500,3500,6000][id-1]} ${translations[currentLanguage].points}`;
            mission.querySelector('.claim-btn').textContent = translations[currentLanguage].claim;
        } else {
            mission.querySelector('p').textContent = `${translations[currentLanguage].reward}: ${[1500,1500,1000,2000,1000][id-14]} ${translations[currentLanguage].points}`;
            mission.querySelector('.social-claim').textContent = translations[currentLanguage].confirm_sub;
        }
    });
    document.querySelector('.mission[data-id="18"] .share-btn').textContent = translations[currentLanguage].share;
    document.getElementById('missions-back').textContent = translations[currentLanguage].back;
    document.getElementById('shop').querySelector('h2').textContent = translations[currentLanguage].shop_title;
    document.querySelector('.shop-item[data-id="1"] h3').textContent = translations[currentLanguage].health_upgrade;
    document.querySelector('.shop-item[data-id="1"] p:nth-child(2)').textContent = translations[currentLanguage].health_desc;
    document.querySelector('.shop-item[data-id="1"] p:nth-child(3)').textContent = `${translations[currentLanguage].price}: 1000 ${translations[currentLanguage].points}`;
    document.querySelector('.shop-item[data-id="2"] h3').textContent = translations[currentLanguage].damage_upgrade;
    document.querySelector('.shop-item[data-id="2"] p:nth-child(2)').textContent = translations[currentLanguage].damage_desc;
    document.querySelector('.shop-item[data-id="2"] p:nth-child(3)').textContent = `${translations[currentLanguage].price}: 2000 ${translations[currentLanguage].points}`;
    document.querySelector('.shop-item[data-id="3"] h3').textContent = translations[currentLanguage].firerate_upgrade;
    document.querySelector('.shop-item[data-id="3"] p:nth-child(2)').textContent = translations[currentLanguage].firerate_desc;
    document.querySelector('.shop-item[data-id="3"] p:nth-child(3)').textContent = `${translations[currentLanguage].price}: 2500 ${translations[currentLanguage].points}`;
    document.querySelector('.shop-item[data-id="4"] h3').textContent = translations[currentLanguage].ammo_upgrade;
    document.querySelector('.shop-item[data-id="4"] p:nth-child(2)').textContent = translations[currentLanguage].ammo_desc;
    document.querySelector('.shop-item[data-id="4"] p:nth-child(3)').textContent = `${translations[currentLanguage].price}: 1500 ${translations[currentLanguage].points}`;
    document.querySelector('.shop-item[data-id="5"] h3').textContent = translations[currentLanguage].speed_upgrade;
    document.querySelector('.shop-item[data-id="5"] p:nth-child(2)').textContent = translations[currentLanguage].speed_desc;
    document.querySelector('.shop-item[data-id="5"] p:nth-child(3)').textContent = `${translations[currentLanguage].price}: 3000 ${translations[currentLanguage].points}`;
    document.querySelector('.shop-item[data-id="6"] h3').textContent = translations[currentLanguage].armor_upgrade;
    document.querySelector('.shop-item[data-id="6"] p:nth-child(2)').textContent = translations[currentLanguage].armor_desc;
    document.querySelector('.shop-item[data-id="6"] p:nth-child(3)').textContent = `${translations[currentLanguage].price}: 4000 ${translations[currentLanguage].points}`;
    document.querySelectorAll('.buy-btn').forEach(btn => btn.textContent = translations[currentLanguage].buy);
    document.getElementById('shop-back').textContent = translations[currentLanguage].back;
    document.getElementById('game-over').querySelector('h2').textContent = translations[currentLanguage].game_over;
    document.getElementById('game-over').querySelector('p:nth-child(2)').textContent = `${translations[currentLanguage].final_score}: ${document.getElementById('final-score').textContent}`;
    document.getElementById('game-over').querySelector('p:nth-child(3)').textContent = `${translations[currentLanguage].completed_missions}: ${document.getElementById('completed-missions').textContent}`;
    document.getElementById('restart-btn').textContent = translations[currentLanguage].restart;
    document.getElementById('menu-btn').textContent = translations[currentLanguage].menu;
}

window.addEventListener('load', () => {
    GameData.load();
    
    const menu = document.getElementById('menu');
    const missions = document.getElementById('missions');
    const shop = document.getElementById('shop');
    
    menu.classList.add('active');
    
    document.querySelectorAll('.social-claim').forEach(btn => {
        const missionId = btn.closest('.mission').dataset.id;
        if (GameData.missions[missionId].completed) {
            btn.disabled = true;
            btn.textContent = translations[currentLanguage].claim;
        }
        
        btn.addEventListener('click', () => {
            if (missionId === '14') {
                if (confirm(translations[currentLanguage].confirm_telegram.replace('{channel}', '@Soko_inu'))) {
                    completeSocialMission(14, 1500);
                }
            } else if (missionId === '15') {
                if (confirm(translations[currentLanguage].confirm_telegram.replace('{channel}', '@tonsocietycahub'))) {
                    completeSocialMission(15, 1500);
                }
            } else if (missionId === '16') {
                if (confirm(translations[currentLanguage].confirm_telegram.replace('{channel}', '@SokoinuTON'))) {
                    completeSocialMission(16, 1000);
                }
            } else if (missionId === '17') {
                if (confirm(translations[currentLanguage].confirm_telegram.replace('{channel}', '@RealSokoInu'))) {
                    completeSocialMission(17, 2000);
                }
            } else if (missionId === '18') {
                completeSocialMission(18, 1000);
            }
        });
    });
    
    document.querySelector('.share-btn').addEventListener('click', () => {
        if (navigator.share) {
            navigator.share({
                title: translations[currentLanguage].title,
                text: translations[currentLanguage].share_text.replace('{score}', GameData.totalScore),
                url: window.location.href
            });
        } else {
            const shareText = `${translations[currentLanguage].title} - ${translations[currentLanguage].share_text.replace('{score}', GameData.totalScore)}\n${window.location.href}`;
            navigator.clipboard.writeText(shareText)
                .then(() => alert(translations[currentLanguage].copied))
                .catch(() => alert(translations[currentLanguage].copy_failed));
        }
    });
    
    document.getElementById('start-btn').addEventListener('click', () => {
        menu.classList.remove('active');
        new ZombieShooter();
    });
    
    document.getElementById('missions-btn').addEventListener('click', () => {
        menu.classList.remove('active');
        missions.classList.add('active');
        updateMissionsUI();
    });
    
    document.getElementById('shop-btn').addEventListener('click', () => {
        menu.classList.remove('active');
        shop.classList.add('active');
        updateShopUI();
    });
    
    document.getElementById('language-btn').addEventListener('click', () => {
        const languages = ['ru', 'en', 'ja'];
        currentLanguage = languages[(languages.indexOf(currentLanguage) + 1) % languages.length];
        updateLanguage();
        updateMissionsUI();
        updateShopUI();
    });
    
    document.getElementById('missions-back').addEventListener('click', () => {
        missions.classList.remove('active');
        menu.classList.add('active');
    });
    
    document.getElementById('shop-back').addEventListener('click', () => {
        shop.classList.remove('active');
        menu.classList.add('active');
    });
    
    document.getElementById('restart-btn').addEventListener('click', () => {
        document.getElementById('game-over').classList.remove('active');
        new ZombieShooter();
    });
    
    document.getElementById('menu-btn').addEventListener('click', () => {
        document.getElementById('game-over').classList.remove('active');
        menu.classList.add('active');
    });
    
    document.querySelectorAll('.buy-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const itemId = e.target.closest('.shop-item').dataset.id;
            buyItem(itemId);
        });
    });
    
    updateLanguage();
});

function completeSocialMission(missionId, reward) {
    if (!GameData.missions[missionId].completed) {
        GameData.missions[missionId].completed = true;
        GameData.totalScore += reward;
        GameData.save();
        GameData.updateUI();
        
        const btn = document.querySelector(`.mission[data-id="${missionId}"] .social-claim`);
        btn.disabled = true;
        btn.textContent = translations[currentLanguage].claim;
        
        alert(translations[currentLanguage].congrats.replace('{reward}', reward));
    }
}

function updateMissionsUI() {
    Object.entries(GameData.missions).forEach(([id, mission]) => {
        const missionElement = document.querySelector(`.mission[data-id="${id}"]`);
        if (missionElement) {
            const claimBtn = missionElement.querySelector('.claim-btn');
            if (id <= 23 && id != 14 && id != 15 && id != 16 && id != 17 && id != 18) {
                const progressElement = missionElement.querySelector('.progress');
                switch (id) {
                    case '1':
                        progressElement.textContent = `${mission.killed}/10`;
                        break;
                    case '2':
                        progressElement.textContent = `${mission.score}/1000`;
                        break;
                    case '3':
                        const minutes3 = Math.floor(mission.time / 60);
                        const seconds3 = Math.floor(mission.time % 60);
                        progressElement.textContent = `${minutes3}:${seconds3.toString().padStart(2, '0')}/5:00`;
                        break;
                    case '4':
                        progressElement.textContent = `${mission.killed}/25`;
                        break;
                    case '5':
                        progressElement.textContent = `${mission.score}/5000`;
                        break;
                    case '6':
                        const minutes6 = Math.floor(mission.time / 60);
                        const seconds6 = Math.floor(mission.time % 60);
                        progressElement.textContent = `${minutes6}:${seconds6.toString().padStart(2, '0')}/10:00`;
                        break;
                    case '7':
                        progressElement.textContent = `${mission.shots}/50`;
                        break;
                    case '8':
                        progressElement.textContent = `${mission.reloads}/20`;
                        break;
                    case '9':
                        progressElement.textContent = `${mission.noDamageKills}/5`;
                        break;
                    case '10':
                        progressElement.textContent = `${mission.ammo}/100`;
                        break;
                    case '11':
                        progressElement.textContent = `${mission.oneShot}/1`;
                        break;
                    case '12':
                        progressElement.textContent = mission.lowHealth ? '1/1' : '0/1';
                        break;
                    case '13':
                        progressElement.textContent = `${mission.quickKills}/3`;
                        break;
                    case '19':
                        progressElement.textContent = `${mission.sessionKilled}/50`;
                        break;
                    case '20':
                        progressElement.textContent = `${mission.combo}/10`;
                        break;
                    case '21':
                        const minutes21 = Math.floor(mission.noReloadTime / 60);
                        const seconds21 = Math.floor(mission.noReloadTime % 60);
                        progressElement.textContent = `${minutes21}:${seconds21.toString().padStart(2, '0')}/2:00`;
                        break;
                    case '22':
                        progressElement.textContent = `${mission.fullHealthKills}/15`;
                        break;
                    case '23':
                        progressElement.textContent = `${mission.sessionScore}/10000`;
                        break;
                }
            }
            
            if (mission.completed) {
                const btn = missionElement.querySelector('.claim-btn, .social-claim');
                btn.disabled = true;
                btn.textContent = translations[currentLanguage].claim;
            }
        }
    });
}

function updateShopUI() {
    document.querySelectorAll('.shop-item').forEach(item => {
        const buyBtn = item.querySelector('.buy-btn');
        const itemId = item.dataset.id;
        const price = {1: 1000, 2: 2000, 3: 2500, 4: 1500, 5: 3000, 6: 4000}[itemId];
        buyBtn.disabled = GameData.totalScore < price;
        buyBtn.textContent = translations[currentLanguage].buy;
    });
}

function buyItem(itemId) {
    const prices = {
        1: 1000,
        2: 2000,
        3: 2500,
        4: 1500,
        5: 3000,
        6: 4000
    };
    
    const price = prices[itemId];
    if (GameData.totalScore >= price) {
        GameData.totalScore -= price;
        switch (itemId) {
            case '1':
                GameData.maxHealth += 20;
                break;
            case '2':
                GameData.damageMultiplier *= 1.25;
                break;
            case '3':
                GameData.shotDelay = Math.max(50, GameData.shotDelay - 50);
                break;
            case '4':
                GameData.maxAmmo += 10;
                break;
            case '5':
                GameData.moveSpeed *= 1.2;
                break;
            case '6':
                GameData.damageReduction *= 0.9;
                break;
        }
        GameData.save();
        GameData.updateUI();
        updateShopUI();
    }
}

window.addEventListener('resize', () => {
    const game = document.querySelector('canvas').parentNode.__vue__;
    if (!game) return;
    
    game.camera.aspect = window.innerWidth / window.innerHeight;
    game.camera.updateProjectionMatrix();
    game.renderer.setSize(window.innerWidth, window.innerHeight);
});
